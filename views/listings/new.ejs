<% layout("/layouts/boilerplate") %>

<style>
    <% categories.forEach(function(category) { %>
        .filter-<%= category.category.toLowerCase().replace(/[^a-z0-9]/g, '') %>:hover {
            background-color: <%= category.color %>;
            cursor: pointer;
        }
    <% }); %>

    .category-checkbpx label {
        cursor: pointer;
    }
</style>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <h3 class="mt-4">Create a New Listing</h3>
        <form id="form" method="POST" action="/listings" class="mb-4 mt-4 needs-validation" novalidate enctype="multipart/form-data">

            <div class="mb-3">
                <label for="title" class="form-label">Title</label>
                <input id="title" type="text" placeholder="Add a catchy title" name="listing[title]" class="form-control" required>
                <div class="valid-feedback">Looks good! A strong title attracts attention.</div>
                <div class="invalid-feedback">Title is required. Try something catchy and concise.</div>
            </div>

            <div class="mb-3">
                <label for="description" class="form-label">Description</label>
                <textarea id="description" placeholder="Enter description" name="listing[description]" class="form-control" required></textarea>
                <div class="valid-feedback">Perfect! A good description helps users understand your listing.</div>
                <div class="invalid-feedback">Please provide a meaningful description for your listing.</div>
            </div>
            
            <div class="mb-3">
                <label for="image-link" class="form-label">Upload Image</label>
                <input id="image-link" type="file" name="listing[image]" class="form-control" required>
                <div class="valid-feedback">Looks good!</div>
                <div class="invalid-feedback">Please upload an image.</div>
            </div>

            <div class="row">
                <div class="col-md-4 mb-3">
                    <label for="price" class="form-label">Price</label>
                    <input id="price" type="number" placeholder="999" name="listing[price]" class="form-control" required>
                    <div class="valid-feedback">Awesome! Price seems reasonable.</div>
                    <div class="invalid-feedback">Price is required. Make sure it's a valid number.</div>
                </div>

                <div class="col-md-8 mb-3">
                    <label for="country" class="form-label">Country</label>
                    <input id="country" type="text" placeholder="India" name="listing[country]" class="form-control" required>
                    <div class="valid-feedback">Nice! Country added successfully.</div>
                    <div class="invalid-feedback">Please enter the country where the listing is located.</div>
                </div>
            </div>

            <div class="mb-3">
                <label for="location" class="form-label">Location</label>
                <input id="location" type="text" placeholder="Delhi, India" name="listing[location]" class="form-control" required>
                <div class="valid-feedback">Location added! Helps users find your listing easily.</div>
                <div class="invalid-feedback">Location is required. Be as specific as possible.</div>
            </div>

            <!-- Category selection using checkboxes -->
            <div class="mb-3 category-checkbpx">
                <label class="form-label">Categories (Select up to 3)</label>
                <div id="categories" class="d-flex flex-wrap gap-3">
                    <% categories.forEach(function(category) { 
                        const safeClass = 'filter-' + category.category.toLowerCase().replace(/[^a-z0-9]/g, '');
                    %>
                        <div class="position-relative">
                            <input type="checkbox" 
                                value="<%= category.category %>" 
                                name="listing[categories][]"
                                id="<%= category.category %>" 
                                class="form-check-input d-none"
                                onchange="updateCategoryStyle('<%= category.category %>', '<%= category.color %>');"
                            >
                            <div class="filter p-2 rounded-3 d-flex align-items-center justify-content-center position-relative <%= safeClass %>">
                                <i class="fa-solid <%= category.icon %> me-2"></i>
                                <%= category.category %>
                                <label for="<%= category.category %>" class="stretched-link position-absolute top-0 start-0 w-100 h-100 m-0"></label>
                            </div>
                        </div>
                    <% }); %>
                </div>
                <div class="valid-feedback">Great! You've selected categories.</div>
                <div class="invalid-feedback">Please select up to 3 categories.</div>
            </div>
            
            <button type="submit" class="btn btn-dark primary-btn">Add</button>
        </form>
    </div>
</div>

<script>
    const categoryCheckboxes = document.querySelectorAll('input[name="listing[categories][]"]');
    const form = document.querySelector('#form');

    //can select only 3 checkbox/category at a time
    function handleCheckboxLimit() {
        const selected = Array.from(categoryCheckboxes).filter(cb => cb.checked);

        if (selected.length >= 3) {
            categoryCheckboxes.forEach(cb => {
                if (!cb.checked) cb.disabled = true;
            });
        } else {
            categoryCheckboxes.forEach(cb => cb.disabled = false);
        }
    }

    // Run on checkbox change
    categoryCheckboxes.forEach(cb => {
        cb.addEventListener('change', handleCheckboxLimit);
    });

    // Check on submit too, not more than 3 category
    form.addEventListener('submit', function (event) {
        const selected = Array.from(categoryCheckboxes).filter(cb => cb.checked);

        if (selected.length > 3) {
            event.preventDefault();
            alert('You can only select up to 3 categories.');
        }
    });

    // corresponding .filter div's background color becomes the category color
    function updateCategoryStyle(category, color) {
        const safeClass = 'filter-' + category.toLowerCase().replace(/[^a-z0-9]/g, '');
        const checkbox = document.getElementById(category);
        const filterDiv = checkbox.nextElementSibling;

        if (checkbox.checked) {
            filterDiv.style.backgroundColor = color;
            filterDiv.style.color = "#fff"; // optional: better contrast
        } else {
            filterDiv.style.backgroundColor = "";
            filterDiv.style.color = ""; // reset to default
        }
    }
</script>